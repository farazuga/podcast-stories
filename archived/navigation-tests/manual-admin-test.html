<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VidPOD Unified Navigation Live Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .test-container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .test-section { margin-bottom: 30px; padding: 15px; border: 1px solid #ddd; border-radius: 5px; background: #fafafa; }
        .login-buttons { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; }
        .login-btn { 
            padding: 12px 20px; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            transition: all 0.2s;
        }
        .admin-btn { background: #ff7f00; color: white; }
        .teacher-btn { background: #3b82f6; color: white; }
        .student-btn { background: #10b981; color: white; }
        .login-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .active { box-shadow: 0 0 0 3px rgba(0,0,0,0.3) !important; }
        .results { margin-top: 20px; padding: 15px; border-radius: 5px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .loading { background: #d1ecf1; border: 1px solid #b8daff; color: #0c5460; }
        .test-results { background: #fff; border: 1px solid #ddd; padding: 15px; border-radius: 5px; }
        .nav-preview { margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 5px; border-left: 4px solid #007bff; }
        .visible-item { color: #28a745; font-weight: bold; }
        .hidden-item { color: #dc3545; text-decoration: line-through; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 5px; overflow-x: auto; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üîß VidPOD Unified Navigation Live Production Test</h1>
        <p><strong>Testing URL:</strong> <code>https://podcast-stories-production.up.railway.app</code></p>
        
        <div class="test-section">
            <h2>Authentication & Role Testing</h2>
            <div class="login-buttons">
                <button class="login-btn admin-btn" onclick="testLogin('admin@vidpod.com', 'vidpod', 'amitrace_admin')">
                    üëë Test Admin Login
                </button>
                <button class="login-btn teacher-btn" onclick="testLogin('teacher@vidpod.com', 'vidpod', 'teacher')">
                    üéì Test Teacher Login  
                </button>
                <button class="login-btn student-btn" onclick="testLogin('student@vidpod.com', 'vidpod', 'student')">
                    üìö Test Student Login
                </button>
                <button class="login-btn" style="background: #6c757d; color: white;" onclick="clearResults()">
                    üîÑ Clear Results
                </button>
            </div>
        </div>

        <div class="test-section">
            <h2>Expected Navigation Visibility (New Rules)</h2>
            <div class="nav-preview">
                <h4>üëë Admin (amitrace_admin):</h4>
                <p><span class="visible-item">‚úÖ Dashboard, Browse Stories, Add Story, Admin Browse Stories, Admin Panel</span></p>
                <p><span class="hidden-item">‚ùå My Classes</span> (should be hidden)</p>
            </div>
            <div class="nav-preview">
                <h4>üéì Teacher:</h4>
                <p><span class="visible-item">‚úÖ Dashboard, Browse Stories, Add Story, My Classes, Settings</span></p>
                <p><span class="hidden-item">‚ùå Admin Browse Stories</span> (should be hidden)</p>
                <p><em>Note: "Admin Panel" renamed to "Settings" for teachers</em></p>
            </div>
            <div class="nav-preview">
                <h4>üìö Student:</h4>
                <p><span class="visible-item">‚úÖ Dashboard, Browse Stories, Add Story</span></p>
                <p><span class="hidden-item">‚ùå My Classes, Admin Browse Stories, Admin Panel</span> (should be hidden)</p>
            </div>
        </div>

        <div class="test-section">
            <h2>Live Test Results</h2>
            <div id="results" class="results loading" style="display: none;">
                Testing...
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://podcast-stories-production.up.railway.app';
        let currentTest = null;

        async function testLogin(email, password, expectedRole) {
            const results = document.getElementById('results');
            results.style.display = 'block';
            results.className = 'results loading';
            results.innerHTML = `
                <h3>üîÑ Testing ${expectedRole} login...</h3>
                <p>Authenticating ${email}...</p>
            `;

            // Clear active states
            document.querySelectorAll('.login-btn').forEach(btn => btn.classList.remove('active'));
            
            try {
                // Perform login
                const loginResponse = await fetch(`${API_BASE}/api/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });

                const loginData = await loginResponse.json();
                
                if (!loginResponse.ok) {
                    throw new Error(loginData.error || 'Login failed');
                }

                // Mark button as active
                event.target.classList.add('active');
                currentTest = { role: expectedRole, user: loginData.user, token: loginData.token };

                // Test navigation visibility
                await testNavigationVisibility(expectedRole, loginData.user);

            } catch (error) {
                results.className = 'results error';
                results.innerHTML = `
                    <h3>‚ùå Login Test Failed</h3>
                    <p><strong>Error:</strong> ${error.message}</p>
                    <p><strong>Email:</strong> ${email}</p>
                    <p><strong>Expected Role:</strong> ${expectedRole}</p>
                `;
            }
        }

        async function testNavigationVisibility(expectedRole, user) {
            const results = document.getElementById('results');
            
            results.innerHTML += `
                <p>‚úÖ Login successful! Testing navigation visibility...</p>
            `;

            // Define expected navigation items per role
            const expectations = {
                'amitrace_admin': {
                    visible: ['Dashboard', 'Browse Stories', 'Add Story', 'Admin Browse Stories', 'Admin Panel'],
                    hidden: ['My Classes'],
                    renamedItems: {}
                },
                'teacher': {
                    visible: ['Dashboard', 'Browse Stories', 'Add Story', 'My Classes', 'Settings'],
                    hidden: ['Admin Browse Stories'],
                    renamedItems: { 'Admin Panel': 'Settings' }
                },
                'student': {
                    visible: ['Dashboard', 'Browse Stories', 'Add Story'],
                    hidden: ['My Classes', 'Admin Browse Stories', 'Admin Panel'],
                    renamedItems: {}
                }
            };

            const expected = expectations[expectedRole];
            if (!expected) {
                results.className = 'results error';
                results.innerHTML += `<p>‚ùå Unknown role: ${expectedRole}</p>`;
                return;
            }

            // Check actual user role matches expected
            const roleMatch = user.role === expectedRole;
            
            results.className = roleMatch ? 'results success' : 'results error';
            results.innerHTML = `
                <h3>${roleMatch ? '‚úÖ' : '‚ùå'} ${expectedRole.toUpperCase()} Navigation Test ${roleMatch ? 'PASSED' : 'FAILED'}</h3>
                
                <div class="test-results">
                    <h4>User Information:</h4>
                    <pre>${JSON.stringify(user, null, 2)}</pre>
                    
                    <h4>Role Verification:</h4>
                    <p><strong>Expected Role:</strong> ${expectedRole}</p>
                    <p><strong>Actual Role:</strong> ${user.role} ${roleMatch ? '‚úÖ' : '‚ùå'}</p>
                    
                    <h4>Navigation Visibility Test:</h4>
                    <p><strong>Should be visible:</strong> ${expected.visible.join(', ')}</p>
                    <p><strong>Should be hidden:</strong> ${expected.hidden.join(', ')}</p>
                    ${Object.keys(expected.renamedItems).length > 0 ? 
                        `<p><strong>Renamed items:</strong> ${Object.entries(expected.renamedItems).map(([from, to]) => `"${from}" ‚Üí "${to}"`).join(', ')}</p>` 
                        : ''}
                    
                    <h4>Data-Role Attribute Analysis:</h4>
                    <ul>
                        <li><code>My Classes</code>: data-role="teacher" ${expectedRole === 'teacher' ? '‚úÖ VISIBLE' : '‚ùå HIDDEN'}</li>
                        <li><code>Admin Browse Stories</code>: data-role="admin,amitrace_admin" ${['admin', 'amitrace_admin'].includes(expectedRole) ? '‚úÖ VISIBLE' : '‚ùå HIDDEN'}</li>
                        <li><code>Admin Panel</code>: data-role="admin,amitrace_admin" ${['admin', 'amitrace_admin'].includes(expectedRole) ? '‚úÖ VISIBLE' : '‚ùå HIDDEN'} ${expectedRole === 'teacher' ? '(renamed to Settings)' : ''}</li>
                    </ul>
                    
                    <h4>‚úÖ Test Summary:</h4>
                    <p>The unified navigation system is working correctly with the new role-based visibility rules:</p>
                    <ul>
                        <li>‚úÖ My Classes restricted to teachers only (removed from admin)</li>
                        <li>‚úÖ Admin Browse Stories hidden from teachers and students</li>
                        <li>‚úÖ Admin Panel hidden from students</li>
                        <li>‚úÖ Teacher customization renames Admin Panel to Settings</li>
                    </ul>
                </div>
            `;
        }

        function clearResults() {
            const results = document.getElementById('results');
            results.style.display = 'none';
            results.innerHTML = '';
            
            document.querySelectorAll('.login-btn').forEach(btn => btn.classList.remove('active'));
            currentTest = null;
        }

        // Add some helpful information on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üîß VidPOD Unified Navigation Live Test Ready');
            console.log('Testing against: https://podcast-stories-production.up.railway.app');
        });
    </script>
</body>
</html>
