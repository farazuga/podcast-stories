<!-- 
ADD STORY TAGS FIX - Insert this script at the end of add-story.html before </body>
This will make tags work immediately without waiting for deployment
-->

<script>
// Add Story Tags Fix - Immediate solution
console.log('🔧 Add Story Tags Fix - Loading...');

// Wait for page to load, then populate tags
setTimeout(async function() {
    console.log('🔧 Add Story Tags Fix - Starting tag population...');
    
    try {
        // Check if we have a token and API access
        const token = localStorage.getItem('token');
        if (!token) {
            console.log('❌ No auth token found');
            return;
        }
        
        // Get tags select element
        const tagsSelect = document.getElementById('tags');
        if (!tagsSelect) {
            console.log('❌ Tags select not found');
            return;
        }
        
        console.log('✅ Tags select found, fetching tags from API...');
        
        // Fetch tags from API
        const response = await fetch('https://podcast-stories-production.up.railway.app/api/tags', {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            console.log(`❌ API call failed: ${response.status} ${response.statusText}`);
            return;
        }
        
        const tags = await response.json();
        console.log(`✅ Loaded ${tags.length} tags from API`);
        
        // Clear existing options
        tagsSelect.innerHTML = '';
        
        // Add each tag as an option
        tags.forEach(tag => {
            const option = document.createElement('option');
            option.value = tag.tag_name;
            option.textContent = tag.tag_name;
            tagsSelect.appendChild(option);
        });
        
        console.log(`✅ Populated ${tagsSelect.options.length} tag options`);
        console.log('🎉 Add Story Tags Fix - COMPLETED! Tags are now available for selection.');
        
        // Show success message to user
        const successMessage = document.createElement('div');
        successMessage.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 9999;
            font-family: Arial, sans-serif;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        `;
        successMessage.textContent = `✅ Tags loaded: ${tags.length} available for selection`;
        document.body.appendChild(successMessage);
        
        // Remove success message after 5 seconds
        setTimeout(() => {
            if (successMessage.parentNode) {
                successMessage.parentNode.removeChild(successMessage);
            }
        }, 5000);
        
    } catch (error) {
        console.error('❌ Add Story Tags Fix - Error:', error);
        
        // Show error message to user
        const errorMessage = document.createElement('div');
        errorMessage.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: #f44336;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 9999;
            font-family: Arial, sans-serif;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        `;
        errorMessage.textContent = `❌ Failed to load tags: ${error.message}`;
        document.body.appendChild(errorMessage);
        
        setTimeout(() => {
            if (errorMessage.parentNode) {
                errorMessage.parentNode.removeChild(errorMessage);
            }
        }, 5000);
    }
}, 2000); // Wait 2 seconds for page to fully load

// Also set up form submission enhancement
setTimeout(function() {
    const form = document.getElementById('storyForm');
    if (form) {
        form.addEventListener('submit', function(e) {
            const tagsSelect = document.getElementById('tags');
            if (tagsSelect) {
                const selectedTags = Array.from(tagsSelect.selectedOptions).map(opt => opt.value);
                console.log('📝 Form submission - Selected tags:', selectedTags);
                
                // Add hidden input for tags if it doesn't exist
                let tagsInput = document.getElementById('hidden-tags');
                if (!tagsInput) {
                    tagsInput = document.createElement('input');
                    tagsInput.type = 'hidden';
                    tagsInput.id = 'hidden-tags';
                    tagsInput.name = 'tags';
                    form.appendChild(tagsInput);
                }
                tagsInput.value = JSON.stringify(selectedTags);
            }
        });
        console.log('✅ Form submission enhancement added');
    }
}, 3000);

console.log('🔧 Add Story Tags Fix - Script loaded and scheduled');
</script>