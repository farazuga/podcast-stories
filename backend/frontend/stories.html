<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VidPOD - Browse Stories</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/navigation.css">
    <link rel="stylesheet" href="css/calendar-widget.css">
</head>
<body>
    <!-- Navigation will auto-load here -->

    <div class="container">
        <!-- Stories Header -->
        <div class="page-header">
            <h1>üìö Browse Stories</h1>
            <p>Discover and explore podcast story ideas from the VidPOD community</p>
        </div>

        <!-- Search & Filter Section -->
        <div class="search-section">
            <h2>üîç Search & Filter</h2>
            <form id="searchForm">
                <div class="search-grid">
                    <div class="form-group">
                        <label>Search Keywords</label>
                        <input type="text" id="searchKeywords" placeholder="Search titles and descriptions...">
                    </div>
                    
                    <div class="form-group">
                        <label>Tags</label>
                        <select id="searchTags" multiple></select>
                    </div>
                    
                    <div class="form-group">
                        <label>Coverage Start Date</label>
                        <input type="date" id="searchStartDate">
                    </div>
                    
                    <div class="form-group">
                        <label>Coverage End Date</label>
                        <input type="date" id="searchEndDate">
                    </div>
                    
                    <div class="form-group">
                        <label>Interviewee</label>
                        <input type="text" id="searchInterviewee" placeholder="Search by interviewee name...">
                    </div>
                </div>
                
                <div class="search-actions">
                    <button type="submit" class="btn btn-primary">üîç Apply Filters</button>
                    <button type="button" class="btn btn-secondary" onclick="clearFilters()">üóëÔ∏è Clear All</button>
                    <div class="search-stats" id="searchStats">
                        <span id="resultsCount">Loading stories...</span>
                    </div>
                </div>
            </form>
        </div>

        <!-- Story Display Options -->
        <div class="display-options">
            <div class="view-controls">
                <button class="btn btn-outline" id="gridViewBtn" onclick="setViewMode('grid')">
                    üì± Grid View
                </button>
                <button class="btn btn-outline active" id="listViewBtn" onclick="setViewMode('list')">
                    üìã List View
                </button>
            </div>
            <div class="selection-controls">
                <label class="checkbox-container">
                    <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()">
                    <span class="checkmark"></span>
                    Select All
                </label>
                <div class="selection-info" id="selectionInfo" style="display: none;">
                    <span id="selectedCount">0</span> selected
                </div>
            </div>
            <div class="sort-controls">
                <label>Sort by:</label>
                <select id="sortBy" onchange="sortStories()">
                    <option value="coverage_newest">Coverage Date (Newest)</option>
                    <option value="coverage_oldest">Coverage Date (Oldest)</option>
                    <option value="newest">Upload Date (Newest)</option>
                    <option value="oldest">Upload Date (Oldest)</option>
                    <option value="title">Title A-Z</option>
                    <option value="author">Author A-Z</option>
                </select>
            </div>
        </div>

        <!-- Bulk Actions Bar -->
        <div class="bulk-actions-bar" id="bulkActionsBar" style="display: none;">
            <div class="bulk-actions-content">
                <div class="bulk-actions-info">
                    <span id="bulkSelectedCount">0</span> stories selected
                </div>
                <div class="bulk-actions-buttons">
                    <button class="btn btn-outline btn-small" onclick="bulkFavorite()">
                        ‚ù§Ô∏è Add to Favorites
                    </button>
                    <button class="btn btn-danger btn-small" onclick="bulkDelete()" id="bulkDeleteBtn" style="display: none;">
                        üóëÔ∏è Delete
                    </button>
                    <button class="btn btn-secondary btn-small" onclick="clearSelection()">
                        ‚úï Clear Selection
                    </button>
                </div>
            </div>
        </div>

        <!-- Stories Grid/List -->
        <div id="storiesContainer" class="stories-container">
            <div id="storiesGrid" class="stories-grid">
                <!-- Stories will be loaded here -->
            </div>
        </div>

        <!-- Pagination Controls -->
        <div class="pagination-section" id="paginationSection">
            <div class="pagination-controls" id="paginationControls" style="display: none;">
                <!-- Pagination buttons will be generated by JavaScript -->
            </div>
        </div>

        <!-- No Results -->
        <div id="noResults" class="no-results" style="display: none;">
            <div class="no-results-content">
                <h3>üîç No Stories Found</h3>
                <p>Try adjusting your search filters or <a href="/add-story.html">create a new story</a>.</p>
            </div>
        </div>
    </div>


    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/date-utils.js"></script>
    <script src="js/calendar-widget.js"></script>
    <script src="js/shared-filters.js"></script>
    <script src="js/stories.js"></script>
    <script src="js/navigation.js"></script>
    <script src="js/include-navigation.js"></script>
    
    <!-- Conditionally load rundown scripts only for teachers/admins -->
    <script>
        // Check user role and conditionally load rundown scripts
        document.addEventListener('DOMContentLoaded', function() {
            try {
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                const userRole = user.role;
                
                // Only load rundown scripts for teachers and admins
                if (userRole === 'teacher' || userRole === 'amitrace_admin') {
                    console.log('üîß Loading rundown scripts for user role:', userRole);
                    
                    // Load rundown utility scripts
                    const rundownUtilsScript = document.createElement('script');
                    rundownUtilsScript.src = 'js/rundown-utils.js';
                    rundownUtilsScript.onload = function() {
                        console.log('‚úÖ Rundown utils loaded successfully');
                    };
                    rundownUtilsScript.onerror = function() {
                        console.warn('‚ö†Ô∏è Failed to load rundown utils - rundown features may not work');
                    };
                    document.head.appendChild(rundownUtilsScript);
                    
                    const rundownStoriesScript = document.createElement('script');
                    rundownStoriesScript.src = 'js/rundown-stories.js';
                    rundownStoriesScript.onload = function() {
                        console.log('‚úÖ Rundown stories integration loaded successfully');
                    };
                    rundownStoriesScript.onerror = function() {
                        console.warn('‚ö†Ô∏è Failed to load rundown stories - rundown buttons may not work');
                    };
                    document.head.appendChild(rundownStoriesScript);
                } else {
                    console.log('üîß Skipping rundown scripts for user role:', userRole || 'unknown');
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Could not determine user role, skipping rundown scripts:', error.message);
            }
        });
    </script>
    
    <!-- Enhanced Date Input with Calendar Support -->
    <script>
        // Simple calendar enhancement for date inputs
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üîß Initializing enhanced date inputs...');
            
            // Enhance date inputs with better user experience
            function enhanceDateInput(inputId, placeholder) {
                const input = document.getElementById(inputId);
                if (input) {
                    // Add helpful placeholder
                    input.placeholder = placeholder;
                    
                    // Add title with instructions
                    input.title = 'Select date using the calendar picker. The calendar shows years but filtering applies to all matching dates regardless of year.';
                    
                    // Add CSS class for styling
                    input.classList.add('enhanced-date-input');
                    
                    // Add event listener for better UX
                    input.addEventListener('change', function() {
                        if (this.value) {
                            console.log(`üìÖ Date selected for ${inputId}: ${this.value}`);
                            // The value will be used for server-side filtering of all database stories
                        }
                    });
                    
                    console.log(`‚úÖ Enhanced date input: ${inputId}`);
                    return true;
                }
                return false;
            }
            
            // Enhance the search date inputs
            const startEnhanced = enhanceDateInput('searchStartDate', 'Coverage start date...');
            const endEnhanced = enhanceDateInput('searchEndDate', 'Coverage end date...');
            
            // Auto-update end date when start date is selected (only if end date is empty)
            if (startEnhanced) {
                const startInput = document.getElementById('searchStartDate');
                const endInput = document.getElementById('searchEndDate');
                if (startInput && endInput) {
                    startInput.addEventListener('change', function() {
                        if (this.value && !endInput.value) {
                            endInput.value = this.value;
                            console.log(`üìÖ Auto-populated end date with: ${this.value}`);
                        }
                    });
                }
            }
            
            console.log(`üìÖ Date input enhancement complete: Start=${startEnhanced}, End=${endEnhanced}`);
            
            // Add helper text for users
            const searchSection = document.querySelector('.search-section');
            if (searchSection && (startEnhanced || endEnhanced)) {
                const helpText = document.createElement('div');
                helpText.className = 'filter-help-text';
                helpText.style.cssText = 'font-size: 12px; color: #666; margin-top: 10px; font-style: italic;';
                helpText.innerHTML = 'üí° <strong>Tip:</strong> Date filtering searches ALL stories in the database and displays coverage dates without years for cleaner viewing.';
                
                const searchActions = document.querySelector('.search-actions');
                if (searchActions) {
                    searchActions.appendChild(helpText);
                }
            }
        });
    </script>
    
    <!-- Additional CSS for enhanced date inputs -->
    <style>
        .enhanced-date-input {
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            padding: 10px;
            font-size: 14px;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        
        .enhanced-date-input:focus {
            border-color: #007cba;
            box-shadow: 0 0 0 3px rgba(0, 124, 186, 0.1);
            outline: none;
        }
        
        .enhanced-date-input:valid {
            border-color: #28a745;
        }
        
        .filter-help-text {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 8px 12px;
            margin-top: 10px;
        }
    </style>
</body>
</html>