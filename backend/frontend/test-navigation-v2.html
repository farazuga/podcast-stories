<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Navigation V2 Test - VidPOD</title>
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="/css/navigation.css">
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f8fafc;
        }
        .test-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 2rem;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .test-status {
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 8px;
            font-weight: 600;
        }
        .success { background: #d1fae5; color: #065f46; border: 1px solid #a7f3d0; }
        .error { background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }
        .info { background: #dbeafe; color: #1e40af; border: 1px solid #93c5fd; }
        .debug-output {
            background: #f3f4f6;
            padding: 1rem;
            border-radius: 8px;
            font-family: monospace;
            font-size: 14px;
            margin: 1rem 0;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <!-- V2 Navigation Component -->
    <script>
        // Load V2 navigation HTML
        fetch('/includes/navigation-v2.html')
            .then(response => response.text())
            .then(html => {
                document.body.insertAdjacentHTML('afterbegin', html);
                return loadV2Script();
            })
            .then(() => {
                initializeV2Test();
            })
            .catch(error => {
                console.error('Failed to load V2 navigation:', error);
                document.getElementById('testStatus').innerHTML = `
                    <div class="test-status error">
                        ‚ùå Failed to load V2 navigation: ${error.message}
                    </div>
                `;
            });

        function loadV2Script() {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = '/js/navigation-v2.js';
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        function initializeV2Test() {
            // Set up admin user for testing
            const testUser = {
                id: 1,
                email: 'admin@vidpod.com',
                name: 'VidPOD Admin',
                role: 'amitrace_admin'
            };
            
            localStorage.setItem('user', JSON.stringify(testUser));
            localStorage.setItem('token', 'test-token-123');
            
            // Initialize V2 navigation
            if (typeof VidPODNav !== 'undefined') {
                VidPODNav.init({
                    currentPage: 'test',
                    user: testUser,
                    onLogout: function() {
                        console.log('V2 Logout called');
                    }
                });
                
                // Test results
                setTimeout(() => {
                    runV2Tests();
                }, 1000);
            } else {
                document.getElementById('testStatus').innerHTML = `
                    <div class="test-status error">
                        ‚ùå VidPODNav V2 not loaded properly
                    </div>
                `;
            }
        }

        function runV2Tests() {
            const results = {
                navExists: !!document.getElementById('vidpodNavbar'),
                adminBrowseVisible: false,
                adminPanelVisible: false,
                teacherDashVisible: false,
                userRole: JSON.parse(localStorage.getItem('user') || '{}').role,
                debugOutput: []
            };

            // Check visibility of admin elements
            const adminBrowse = document.querySelector('[href="/admin-browse-stories.html"]');
            const adminPanel = document.querySelector('[href="/admin.html"]');
            const teacherDash = document.querySelector('[href="/teacher-dashboard.html"]');

            if (adminBrowse) {
                results.adminBrowseVisible = window.getComputedStyle(adminBrowse).display !== 'none';
                results.debugOutput.push(`Admin Browse: display=${adminBrowse.style.display}, computed=${window.getComputedStyle(adminBrowse).display}`);
            }

            if (adminPanel) {
                results.adminPanelVisible = window.getComputedStyle(adminPanel).display !== 'none';
                results.debugOutput.push(`Admin Panel: display=${adminPanel.style.display}, computed=${window.getComputedStyle(adminPanel).display}`);
            }

            if (teacherDash) {
                results.teacherDashVisible = window.getComputedStyle(teacherDash).display !== 'none';
                results.debugOutput.push(`Teacher Dash: display=${teacherDash.style.display}, computed=${window.getComputedStyle(teacherDash).display}`);
            }

            // Check all data-role elements
            document.querySelectorAll('[data-role]').forEach(element => {
                const roles = element.getAttribute('data-role');
                const isVisible = window.getComputedStyle(element).display !== 'none';
                const text = element.textContent?.trim() || element.getAttribute('href') || 'unnamed';
                results.debugOutput.push(`Element "${text}": roles=${roles}, visible=${isVisible}`);
            });

            displayV2Results(results);
        }

        function displayV2Results(results) {
            const success = results.navExists && results.adminBrowseVisible && results.adminPanelVisible;
            const statusClass = success ? 'success' : 'error';
            const statusIcon = success ? '‚úÖ' : '‚ùå';

            document.getElementById('testStatus').innerHTML = `
                <div class="test-status ${statusClass}">
                    ${statusIcon} Navigation V2 Test: ${success ? 'SUCCESS' : 'FAILED'}
                </div>
                <div class="test-status info">
                    üìä Test Results for role: ${results.userRole}
                    <ul>
                        <li>Navigation exists: ${results.navExists ? '‚úÖ' : '‚ùå'}</li>
                        <li>Admin Browse visible: ${results.adminBrowseVisible ? '‚úÖ' : '‚ùå'}</li>
                        <li>Admin Panel visible: ${results.adminPanelVisible ? '‚úÖ' : '‚ùå'}</li>
                        <li>Teacher Dashboard visible: ${results.teacherDashVisible ? '‚úÖ' : '‚ùå'}</li>
                    </ul>
                </div>
                <div class="debug-output">${results.debugOutput.join('\n')}</div>
            `;
        }
    </script>

    <div class="test-container">
        <h1>üîß VidPOD Navigation V2 Test</h1>
        <p>This page tests the fixed V2 navigation files with complete amitrace_admin support.</p>
        
        <div id="testStatus">
            <div class="test-status info">
                üîÑ Loading V2 navigation components...
            </div>
        </div>

        <div class="test-status info">
            <strong>Expected Behavior:</strong>
            <ul>
                <li>User role should be 'amitrace_admin'</li>
                <li>Admin Browse Stories should be visible</li>
                <li>Admin Panel should be visible</li>
                <li>Teacher Dashboard should be visible</li>
                <li>All data-role elements should respect amitrace_admin role</li>
            </ul>
        </div>
    </div>
</body>
</html>